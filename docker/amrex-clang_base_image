FROM ubuntu:18.04

ARG CI_JOB_TOKEN
ENV CI_JOB_TOKEN ${CI_JOB_TOKEN}

ARG DEBIAN_FRONTEND=noninteractive
RUN apt-get update \
  && apt-get --yes dist-upgrade \
  && apt-get install --yes gfortran python3-pip wget libpthread-stubs0-dev git libopenmpi-dev m4 \
  && pip3 install conan

# Install latest CMake files from the internet
RUN wget https://github.com/Kitware/CMake/releases/download/v3.14.2/cmake-3.14.2-Linux-x86_64.tar.gz \
    && tar xzf cmake-3.14.2-Linux-x86_64.tar.gz && rm cmake-3.14.2-Linux-x86_64.tar.gz \
    && cp -r cmake-3.14.2-Linux-x86_64/* /usr/ && rm -r cmake-3.14.2-Linux-x86_64/

# Fetch clang-compiler and install it into /usr
ARG CLANG_URL
RUN mkdir llvm_download \
  && cd llvm_download \
  && wget "${CLANG_URL}" \
  && tar xf *.tar.xz \
  && rm *.tar.xz \
  && cp -r $(ls .)/* /usr \
  && cd ../ \
  && rm -r llvm_download

ARG CLANG_VERSION
RUN conan remote add finite-volume https://api.bintray.com/conan/fub-agklein/finite-volume \
 && conan remote add gitlab https://git.imp.fu-berlin.de/api/v4/packages/conan \
 && conan profile new linux-clang --detect \
 && conan profile update settings.compiler=clang linux-clang \
 && conan profile update settings.compiler.version=${CLANG_VERSION} linux-clang \
 && conan profile update settings.compiler.libcxx=libc++ linux-clang \
 && conan profile update settings.compiler.cppstd=11 linux-clang \
 && conan profile update env.CC=clang linux-clang \
 && conan profile update env.CXX=clang++ linux-clang \
 && conan user ci_user -r gitlab -p ${CI_JOB_TOKEN}

RUN conan install boost/1.71.0@conan/stable --profile linux-clang --build missing \
 && conan install eigen/3.3.7@conan/stable --profile linux-clang --build missing \
 && conan install pybind11/2.3.0@conan/stable --profile linux-clang --build missing \
 && conan install fmt/5.3.0@bincrafters/stable --profile linux-clang --build missing
