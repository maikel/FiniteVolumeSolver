ARG UBUNTU_VERSION
FROM ubuntu:$UBUNTU_VERSION

ENV CI_JOB_TOKEN=$CI_JOB_TOKEN

RUN apt-get update \
  && apt-get --yes dist-upgrade \
  && apt-get install --yes gfortran python3-pip wget libpthread-stubs0-dev git libopenmpi-dev m4 \
  && pip3 install conan

# Install latest CMake files from the internet
RUN wget https://github.com/Kitware/CMake/releases/download/v3.14.2/cmake-3.14.2-Linux-x86_64.tar.gz \
    && tar xzf cmake-3.14.2-Linux-x86_64.tar.gz && rm cmake-3.14.2-Linux-x86_64.tar.gz \
    && cp -r cmake-3.14.2-Linux-x86_64/* /usr/ && rm -r cmake-3.14.2-Linux-x86_64/

RUN conan remote add finite-volume https://api.bintray.com/conan/fub-agklein/finite-volume
RUN conan remote add gitlab https://git.imp.fu-berlin.de/api/v4/packages/conan
RUN conan profile new default --detect
RUN conan user ci_user -r gitlab -p ${CI_JOB_TOKEN}

RUN sed s/libstdc++/libstdc++11/ -i /root/.conan/profiles/default
RUN conan install boost/1.71.0@conan/stable --build missing                                \
    && conan install eigen/3.3.7@conan/stable  --build missing                             \
    && conan install fmt/5.3.0@bincrafters/stable --build missing                          \
    && conan install Vc/1.4.1@finite-volume/stable --build missing                         \
    && conan install SAMRAI/3.15.0@finite-volume/stable --build missing                    \
    && conan install pybind11/2.3.0@conan/stable --build missing

# ARG AMREX_SPACEDIM
# ARG CACHEBUST=1
# RUN conan install "AMReX/20.04@finite-volume/stable"              \
#                   -o AMReX:dim="${AMREX_SPACEDIM}"                \
#                   --build AMReX
